#!/bin/bash
DB_NAME="{{DB_NAME}}"; DB_USER="{{DB_USER}}"; DB_PASS="{{DB_PASS}}"; BACKUP_DIR="/www/backup/db"; TIMESTAMP=$(date +%F_%H-%M); BAK_NAME="${DB_NAME}_${TIMESTAMP}.sql.gz"; BAK_PATH="${BACKUP_DIR}/${BAK_NAME}"; mkdir -p "$BACKUP_DIR"; if /usr/bin/mysqldump -h127.0.0.1 --no-tablespaces -u$DB_USER -p$DB_PASS $DB_NAME | /bin/gzip > "$BAK_PATH"; then echo "[$(date)] ✅ 备份成功：$BAK_NAME"; else echo "[$(date)] ❌ 备份失败：$BAK_NAME" >&2; exit 1; fi; if /usr/bin/curl -s -F "file=@${BAK_PATH}" {{REMOTE_HOST}}/method/upload.php; then echo "[$(date)] ✅ 上传成功：$BAK_NAME"; else echo "[$(date)] ❌ 上传失败：$BAK_NAME" >&2; fi; cd "$BACKUP_DIR" && ls -t *.sql.gz | tail -n +$(({{KEEP_COUNT}} + 1)) | xargs -r rm -f
